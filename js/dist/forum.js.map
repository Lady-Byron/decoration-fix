{"version":3,"file":"forum.js","mappings":"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","sources":["webpack://@lady-byron/decoration-fix/webpack/bootstrap","webpack://@lady-byron/decoration-fix/webpack/runtime/compat get default export","webpack://@lady-byron/decoration-fix/webpack/runtime/define property getters","webpack://@lady-byron/decoration-fix/webpack/runtime/hasOwnProperty shorthand","webpack://@lady-byron/decoration-fix/./node_modules/@babel/runtime/helpers/esm/extends.js","webpack://@lady-byron/decoration-fix/external root \"flarum.core.compat['forum/app']\"","webpack://@lady-byron/decoration-fix/./src/forum/index.js"],"sourcesContent":["// The require scope\nvar __webpack_require__ = {};\n\n","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","function _extends() {\n  return _extends = Object.assign ? Object.assign.bind() : function (n) {\n    for (var e = 1; e < arguments.length; e++) {\n      var t = arguments[e];\n      for (var r in t) ({}).hasOwnProperty.call(t, r) && (n[r] = t[r]);\n    }\n    return n;\n  }, _extends.apply(null, arguments);\n}\nexport { _extends as default };","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/app'];","import app from 'flarum/forum/app';\n\nconst LOG = '[decoration-fix v1]';\n\n/**\n * A) displayName 适配器：\n *    - 渲染阶段保留 user-decoration 的富对象/装饰\n *    - 序列化阶段（JSON.stringify / ''+obj）返回纯字符串，避免环引用\n */\nfunction installDisplayNameAdapter() {\n  try {\n    const compat = window.flarum?.core?.compat || window.flarum?.compat || {};\n    const UserMod = compat['models/User'] || compat['common/models/User'];\n    const User = UserMod && (UserMod.default || UserMod);\n    if (!User || User.prototype.__lb_df_dn_patched) return;\n\n    const orig = User.prototype.displayName;\n\n    User.prototype.displayName = function () {\n      let v;\n      try {\n        v = orig ? orig.call(this) : (this.username?.() ?? this.attribute?.('username'));\n      } catch (e) {}\n\n      // 已是字符串：直接返回\n      if (typeof v === 'string') return v;\n\n      // 若是对象（被 user-decoration 包装），为其加 toJSON/toString\n      if (v && typeof v === 'object') {\n        // 只从原始字段取“纯文本名”；避免再次调用 displayName 造成递归\n        const text =\n          this.attribute?.('displayName') ||\n          this.username?.() ||\n          this.attribute?.('username') ||\n          '';\n\n        try { Object.defineProperty(v, 'toJSON',  { value: () => text, configurable: true }); }\n        catch { v.toJSON  = () => text; }\n\n        if (!v.toString || v.toString === Object.prototype.toString) {\n          try { Object.defineProperty(v, 'toString', { value: () => text, configurable: true }); }\n          catch { v.toString = () => text; }\n        }\n      }\n      return v;\n    };\n\n    User.prototype.__lb_df_dn_patched = true;\n    // eslint-disable-next-line no-console\n    console.log(LOG, 'displayName adapter installed');\n  } catch (e) {\n    // eslint-disable-next-line no-console\n    console.warn(LOG, 'displayName adapter error, retrying…', e);\n    setTimeout(installDisplayNameAdapter, 120);\n  }\n}\n\n/**\n * B) Typing 兜底：\n *    - 仅在 {event:'client-typing', data:{…}} 被 stringify 时，确保 displayName 为字符串\n *    - 不影响其他 JSON.stringify 用途\n */\nfunction installTypingGuard() {\n  if (JSON.stringify.__lb_df_guard) return;\n  const _stringify = JSON.stringify;\n\n  const isTypingRoot = (val) =>\n    val && typeof val === 'object' &&\n    'event' in val && 'data' in val &&\n    String(val.event || '').toLowerCase().includes('typing');\n\n  JSON.stringify = function (val, replacer, space) {\n    try {\n      if (isTypingRoot(val) && replacer === undefined) {\n        const data = { ...(val.data || {}) };\n        if (typeof data.displayName !== 'string') {\n          try {\n            // 优先使用对象自带的 toJSON（由上方适配器提供），否则再兜底转字符串\n            data.displayName =\n              (data.displayName && data.displayName.toJSON && data.displayName.toJSON()) ||\n              String(data.displayName || '');\n          } catch {\n            data.displayName = '';\n          }\n        }\n        return _stringify.call(this, { event: val.event, data }, undefined, space);\n      }\n    } catch { /* ignore */ }\n    return _stringify.call(this, val, replacer, space);\n  };\n  JSON.stringify.__lb_df_guard = true;\n  // eslint-disable-next-line no-console\n  console.log(LOG, 'typing guard installed');\n}\n\napp.initializers.add('lady-byron-decoration-fix', () => {\n  installDisplayNameAdapter();\n  installTypingGuard();\n});\n"],"names":["__webpack_require__","module","getter","__esModule","d","a","exports","definition","key","o","Object","defineProperty","enumerable","get","obj","prop","prototype","hasOwnProperty","call","_extends","assign","bind","n","e","arguments","length","t","r","apply","flarum","core","compat","LOG","installDisplayNameAdapter","_window$flarum","_window$flarum2","window","UserMod","User","__lb_df_dn_patched","orig","displayName","v","_this$username","_this$username2","_this$attribute","this","username","attribute","_this$attribute2","_this$username3","_this$attribute3","text","value","configurable","_unused","toJSON","toString","_unused2","console","log","warn","setTimeout","app","add","JSON","stringify","__lb_df_guard","_stringify","val","replacer","space","String","event","toLowerCase","includes","isTypingRoot","undefined","data","_unused3","_unused4","installTypingGuard"],"sourceRoot":""}